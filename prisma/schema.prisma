// Healthcare Clinical Documentation System - Prisma Schema
// Design Principles:
// - Human-readable schema
// - Avoid EAV pattern for clinical data
// - Proper normalization
// - Clinical chart data in real columns (not key/value)
// - Production-ready and clean

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================
// 1️⃣ Providers
// ===============================
/// Stores provider/clinician information including name, specialty, and contact details
model Provider {
  providerId    Int      @id @default(autoincrement()) @map("provider_id")
  providerName  String   @db.VarChar(255) @map("provider_name")
  specialty     String?  @db.VarChar(255)
  contactInfo   Json?    @map("contact_info")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  appointments  Appointment[]

  @@map("t_kb_provider")
}

// ===============================
// 2️⃣ Patients
// ===============================
/// Stores patient demographics including name, DOB, gender, insurance, and contact information
model Patient {
  patientId     Int      @id @default(autoincrement()) @map("patient_id")
  fullName      String   @db.VarChar(255) @map("full_name")
  dateOfBirth   DateTime? @db.Date @map("date_of_birth")
  gender        String?  @db.VarChar(10)
  insurance     Json?    
  contactInfo   Json?    @map("contact_info")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  appointments  Appointment[]

  @@map("t_kb_patient")
}

// ===============================
// 3️⃣ Appointment Type (Lookup Table)
// ===============================
/// Lookup table defining visit classifications. Consolidates type_of_visit, type_of_service, and place_of_service into a single normalized table
model AppointmentType {
  appointmentTypeId Int      @id @default(autoincrement()) @map("appointment_type_id")
  typeOfVisit       String   @db.VarChar(100) @map("type_of_visit")  // e.g., New, Established, ER
  typeOfService     String   @db.VarChar(100) @map("type_of_service")  // e.g., Office Visit, Surgery
  placeOfService    String   @db.VarChar(100) @map("place_of_service")  // e.g., Clinic, Hospital, Telehealth
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  appointments      Appointment[]

  @@unique([typeOfVisit, typeOfService, placeOfService])
  @@map("t_kb_appointment_type")
}

// ===============================
// 4️⃣ Appointments (Scheduling Only)
// ===============================
/// Stores appointment scheduling information only. Clinical documentation is stored in t_kb_chart_info
model Appointment {
  appointmentId     Int      @id @default(autoincrement()) @map("appointment_id")
  patientId         Int      @map("patient_id")
  providerId        Int      @map("provider_id")
  appointmentTypeId Int      @map("appointment_type_id")
  appointmentDate   DateTime @map("appointment_date")
  durationMin       Int?     @map("duration_min")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  patient           Patient  @relation(fields: [patientId], references: [patientId], onDelete: Cascade)
  provider          Provider @relation(fields: [providerId], references: [providerId], onDelete: Cascade)
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [appointmentTypeId], onDelete: Restrict)
  chartInfo         ChartInfo?

  @@map("t_kb_appointment")
}

// ===============================
// 5️⃣ Field Definitions (Metadata Layer)
// ===============================
/// Metadata table for UI configuration and validation. field_key values must match column names in t_kb_chart_info. Does NOT store patient data.
model FieldDefinition {
  fieldId      Int      @id @default(autoincrement()) @map("field_id")
  fieldKey     String   @unique @db.VarChar(100) @map("field_key")  // Must match column names in t_kb_chart_info
  displayName  String?  @db.VarChar(255) @map("display_name")
  description String?  @db.Text
  dataType    String   @default("text") @db.VarChar(50) @map("data_type")
  isRequired  Boolean  @default(false) @map("is_required")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("t_kb_field_definitions")
}

// ===============================
// 6️⃣ Chart Info (Clinical Data)
// ===============================
/// Stores actual patient clinical documentation. One row per appointment with all clinical fields as columns. 
/// Avoids EAV pattern for better performance and readability. Column names match t_kb_field_definitions.field_key values.
/// UNIQUE constraint ensures one chart record per appointment. CASCADE delete removes chart when appointment is deleted.
model ChartInfo {
  chartInfoId            Int      @id @default(autoincrement()) @map("chart_info_id")
  appointmentId          Int      @unique @map("appointment_id")
  
  // All 27 clinical fields as columns (from t_kb_field_definitions.field_key)
  calculatedAge          String?  @db.Text @map("calculated_age")
  patientGender          String?  @db.Text @map("patient_gender")
  chiefComplient         String?  @db.Text @map("chief_complient")
  historyOfIllness       String?  @db.Text @map("history_of_illness")
  history                String?  @db.Text
  ros                    String?  @db.Text
  physicalExam           String?  @db.Text @map("physical_exam")
  vitalSigns             String?  @db.Text @map("vital_signs")
  assessment             String?  @db.Text
  clinicalImpression     String?  @db.Text @map("clinical_impression")
  diagnosis              String?  @db.Text
  plan                   String?  @db.Text
  planAndPrognosis       String?  @db.Text @map("plan_and_prognosis")
  procedure              String?  @db.Text
  descriptionOfProcedure String?  @db.Text @map("description_of_procedure")
  operativeProcedure     String?  @db.Text @map("operative_procedure")
  preOpDiagnosis         String?  @db.Text @map("pre_op_diagnosis")
  postOpDiagnosis        String?  @db.Text @map("post_op_diagnosis")
  postOfImpression       String?  @db.Text @map("post_of_impression")
  postOpOrder            String?  @db.Text @map("post_op_order")
  testAndOrders          String?  @db.Text @map("test_and_orders")
  insuranceCategories    String?  @db.Text @map("insurance_categories")
  insuranceCompanies     String?  @db.Text @map("insurance_companies")
  
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  appointment            Appointment @relation(fields: [appointmentId], references: [appointmentId], onDelete: Cascade)

  @@map("t_kb_chart_info")
}

// ===============================
// Login Info
// ===============================
model LoginInfo {
  id             String   @id @default(cuid())
  username       String   @unique
  hashedPassword String   @map("hashed_password")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("t_login_info")
}
